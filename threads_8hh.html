<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Underpass: data/threads.hh File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Underpass
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_472fafaf0f039b9e6b043966c1ef7dbf.html">data</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">threads.hh File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Threads for monitoring the OSM planet server for replication files.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;string&gt;</code><br />
<code>#include &lt;vector&gt;</code><br />
<code>#include &lt;iostream&gt;</code><br />
<code>#include &lt;pqxx/pqxx&gt;</code><br />
<code>#include &lt;future&gt;</code><br />
<code>#include &lt;thread&gt;</code><br />
<code>#include &lt;mutex&gt;</code><br />
<code>#include &lt;condition_variable&gt;</code><br />
<code>#include &lt;ogr_geometry.h&gt;</code><br />
<code>#include &lt;boost/date_time.hpp&gt;</code><br />
<code>#include &quot;boost/date_time/posix_time/posix_time.hpp&quot;</code><br />
<code>#include &lt;boost/beast/core.hpp&gt;</code><br />
<code>#include &lt;boost/beast/http.hpp&gt;</code><br />
<code>#include &lt;boost/beast/version.hpp&gt;</code><br />
<code>#include &lt;boost/asio/connect.hpp&gt;</code><br />
<code>#include &lt;boost/asio/ip/tcp.hpp&gt;</code><br />
<code>#include &lt;boost/asio/ssl/error.hpp&gt;</code><br />
<code>#include &lt;boost/asio/ssl/stream.hpp&gt;</code><br />
<code>#include &lt;boost/beast/http/parser.hpp&gt;</code><br />
<code>#include &quot;<a class="el" href="replication_8hh_source.html">osmstats/replication.hh</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="osmstats_8hh_source.html">osmstats/osmstats.hh</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for threads.hh:</div>
<div class="dyncontent">
<div class="center"><img src="threads_8hh__incl.png" border="0" usemap="#adata_2threads_8hh" alt=""/></div>
<map name="adata_2threads_8hh" id="adata_2threads_8hh">
<area shape="rect" title="Threads for monitoring the OSM planet server for replication files." alt="" coords="1409,5,1519,32"/>
<area shape="rect" title=" " alt="" coords="1687,475,1742,502"/>
<area shape="rect" title=" " alt="" coords="432,475,491,502"/>
<area shape="rect" title=" " alt="" coords="273,475,345,502"/>
<area shape="rect" title=" " alt="" coords="398,319,477,345"/>
<area shape="rect" title=" " alt="" coords="2967,80,3022,107"/>
<area shape="rect" title=" " alt="" coords="397,162,456,189"/>
<area shape="rect" title=" " alt="" coords="481,162,538,189"/>
<area shape="rect" title=" " alt="" coords="3046,80,3173,107"/>
<area shape="rect" title=" " alt="" coords="550,393,661,420"/>
<area shape="rect" title=" " alt="" coords="1448,475,1587,502"/>
<area shape="rect" title=" " alt="" coords="944,468,1093,509"/>
<area shape="rect" title=" " alt="" coords="3197,80,3339,107"/>
<area shape="rect" title=" " alt="" coords="3363,80,3503,107"/>
<area shape="rect" title=" " alt="" coords="3528,80,3688,107"/>
<area shape="rect" title=" " alt="" coords="562,162,718,189"/>
<area shape="rect" title=" " alt="" coords="2429,162,2571,189"/>
<area shape="rect" title=" " alt="" coords="2596,162,2753,189"/>
<area shape="rect" title=" " alt="" coords="2777,162,2948,189"/>
<area shape="rect" title=" " alt="" coords="3713,80,3893,107"/>
<area shape="rect" href="replication_8hh.html" title="This class downloads replication files, and adds them to the database." alt="" coords="1329,80,1485,107"/>
<area shape="rect" href="osmstats_8hh.html" title="This file is used to work with the OSM Stats database." alt="" coords="678,244,829,271"/>
<area shape="rect" title=" " alt="" coords="1228,162,1308,189"/>
<area shape="rect" title=" " alt="" coords="1333,162,1393,189"/>
<area shape="rect" title=" " alt="" coords="1417,162,1487,189"/>
<area shape="rect" title=" " alt="" coords="1511,162,1676,189"/>
<area shape="rect" title=" " alt="" coords="1700,155,1839,196"/>
<area shape="rect" title=" " alt="" coords="1863,162,2001,189"/>
<area shape="rect" title=" " alt="" coords="2025,162,2156,189"/>
<area shape="rect" title=" " alt="" coords="2180,162,2353,189"/>
<area shape="rect" title=" " alt="" coords="1621,393,1704,420"/>
<area shape="rect" title=" " alt="" coords="398,244,466,271"/>
<area shape="rect" href="changeset_8hh.html" title="The file is used for processing changeset files." alt="" coords="895,162,1052,189"/>
<area shape="rect" title=" " alt="" coords="736,393,787,420"/>
<area shape="rect" title=" " alt="" coords="811,393,879,420"/>
<area shape="rect" title=" " alt="" coords="955,244,1002,271"/>
<area shape="rect" title=" " alt="" coords="1026,244,1065,271"/>
<area shape="rect" title=" " alt="" coords="1089,244,1205,271"/>
<area shape="rect" href="osmobjects_8hh.html" title="Data structures for OSM objects." alt="" coords="1158,393,1293,420"/>
<area shape="rect" title=" " alt="" coords="603,319,677,345"/>
<area shape="rect" href="osmchange_8hh.html" title="This file parses a change file in the OsmChange format." alt="" coords="955,319,1119,345"/>
<area shape="rect" title=" " alt="" coords="1118,475,1250,502"/>
<area shape="rect" title=" " alt="" coords="1274,475,1409,502"/>
</map>
</div>
</div><div class="textblock"><div class="dynheader">
This graph shows which files directly or indirectly include this file:</div>
<div class="dyncontent">
<div class="center"><img src="threads_8hh__dep__incl.png" border="0" usemap="#adata_2threads_8hhdep" alt=""/></div>
<map name="adata_2threads_8hhdep" id="adata_2threads_8hhdep">
<area shape="rect" title="Threads for monitoring the OSM planet server for replication files." alt="" coords="28,5,139,32"/>
<area shape="rect" href="replication_8hh.html" title="This class downloads replication files, and adds them to the database." alt="" coords="5,80,161,107"/>
<area shape="rect" href="underpass_8hh.html" title="Underpass for monitoring the OSM planet server for replication files." alt="" coords="19,155,147,181"/>
</map>
</div>
</div>
<p><a href="threads_8hh_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:a60a92ea513bd2f25705cdd673983c5a8"><td class="memItemLeft" align="right" valign="top"><a id="a60a92ea513bd2f25705cdd673983c5a8"></a>
using&#160;</td><td class="memItemRight" valign="bottom"><b>tcp</b> = net::ip::tcp</td></tr>
<tr class="separator:a60a92ea513bd2f25705cdd673983c5a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a682dae5c70821d6a5261779edbb06d8f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><b>threads::startStateThreads</b> (const std::string &amp;base, const std::string &amp;file)</td></tr>
<tr class="separator:a682dae5c70821d6a5261779edbb06d8f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad101491c3fe6a688c4f1dd6eeaaea6fc"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><b>threads::startMonitor</b> (const <a class="el" href="classreplication_1_1RemoteURL.html">replication::RemoteURL</a> &amp;inr, const multipolygon_t &amp;poly, const std::string &amp;dburl)</td></tr>
<tr class="separator:ad101491c3fe6a688c4f1dd6eeaaea6fc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a53ed6a264f7e68b955962b33024f5b3f"><td class="memItemLeft" align="right" valign="top"><a id="a53ed6a264f7e68b955962b33024f5b3f"></a>
std::shared_ptr&lt; <a class="el" href="classreplication_1_1StateFile.html">replication::StateFile</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>threads::threadStateFile</b> (ssl::stream&lt; tcp::socket &gt; &amp;stream, const std::string &amp;file)</td></tr>
<tr class="memdesc:a53ed6a264f7e68b955962b33024f5b3f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates the states table in the Underpass database. <br /></td></tr>
<tr class="separator:a53ed6a264f7e68b955962b33024f5b3f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a69efac993e30df10bfc554e6e7acf6dc"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><b>threads::threadOsmChange</b> (const <a class="el" href="classreplication_1_1RemoteURL.html">replication::RemoteURL</a> &amp;remote, const multipolygon_t &amp;poly, <a class="el" href="classosmstats_1_1QueryOSMStats.html">osmstats::QueryOSMStats</a> &amp;ostats)</td></tr>
<tr class="separator:a69efac993e30df10bfc554e6e7acf6dc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa06bd8935abc99c9ad5be739d887eb46"><td class="memItemLeft" align="right" valign="top">std::shared_ptr&lt; <a class="el" href="classreplication_1_1StateFile.html">replication::StateFile</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>threads::threadChangeSet</b> (const <a class="el" href="classreplication_1_1RemoteURL.html">replication::RemoteURL</a> &amp;remote, const multipolygon_t &amp;poly, <a class="el" href="classosmstats_1_1QueryOSMStats.html">osmstats::QueryOSMStats</a> &amp;ostats)</td></tr>
<tr class="separator:aa06bd8935abc99c9ad5be739d887eb46"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8048675cb3b9451a7b9b187a570cbd46"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><b>threads::threadStatistics</b> (const std::string &amp;database, ptime &amp;timestamp)</td></tr>
<tr class="separator:a8048675cb3b9451a7b9b187a570cbd46"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add8d616d7a0e96751115c3aa3e1aaefd"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="threads_8hh.html#add8d616d7a0e96751115c3aa3e1aaefd">threads::threadOSM</a> (const std::string &amp;database, ptime &amp;timestamp)</td></tr>
<tr class="separator:add8d616d7a0e96751115c3aa3e1aaefd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Threads for monitoring the OSM planet server for replication files. </p>
<p>These are the threads used to download and apply the replication files to a database. The monitor the OSM planet server for updated replication files. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="ad101491c3fe6a688c4f1dd6eeaaea6fc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad101491c3fe6a688c4f1dd6eeaaea6fc">&#9670;&nbsp;</a></span>startMonitor()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void threads::startMonitor </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classreplication_1_1RemoteURL.html">replication::RemoteURL</a> &amp;&#160;</td>
          <td class="paramname"><em>remote</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const multipolygon_t &amp;&#160;</td>
          <td class="paramname"><em>poly</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>dburl</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This monitors the planet server for new files of the specified type. It does a bulk download to catch up the database, then checks for the minutely change files and processes them. </p>

</div>
</div>
<a id="a682dae5c70821d6a5261779edbb06d8f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a682dae5c70821d6a5261779edbb06d8f">&#9670;&nbsp;</a></span>startStateThreads()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void threads::startStateThreads </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>file</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This handler downloads state.txt files from planet, newest first, and then goes backwards in time. This is used to populate database tables with only newer data. </p>

</div>
</div>
<a id="aa06bd8935abc99c9ad5be739d887eb46"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa06bd8935abc99c9ad5be739d887eb46">&#9670;&nbsp;</a></span>threadChangeSet()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::shared_ptr&lt; <a class="el" href="classreplication_1_1StateFile.html">replication::StateFile</a> &gt; threads::threadChangeSet </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classreplication_1_1RemoteURL.html">replication::RemoteURL</a> &amp;&#160;</td>
          <td class="paramname"><em>remote</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const multipolygon_t &amp;&#160;</td>
          <td class="paramname"><em>poly</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classosmstats_1_1QueryOSMStats.html">osmstats::QueryOSMStats</a> &amp;&#160;</td>
          <td class="paramname"><em>ostats</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This updates several fields in the raw_changesets table, which are part of the changeset file, and don't need to be calculated. </p>

</div>
</div>
<a id="add8d616d7a0e96751115c3aa3e1aaefd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#add8d616d7a0e96751115c3aa3e1aaefd">&#9670;&nbsp;</a></span>threadOSM()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void threads::threadOSM </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ptime &amp;&#160;</td>
          <td class="paramname"><em>timestamp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This updates an OSM database, which can be used for extracts and other validation. </p>

</div>
</div>
<a id="a69efac993e30df10bfc554e6e7acf6dc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a69efac993e30df10bfc554e6e7acf6dc">&#9670;&nbsp;</a></span>threadOsmChange()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool threads::threadOsmChange </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classreplication_1_1RemoteURL.html">replication::RemoteURL</a> &amp;&#160;</td>
          <td class="paramname"><em>remote</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const multipolygon_t &amp;&#160;</td>
          <td class="paramname"><em>poly</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="classosmstats_1_1QueryOSMStats.html">osmstats::QueryOSMStats</a> &amp;&#160;</td>
          <td class="paramname"><em>ostats</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Updates the raw_hashtags, raw_users, and raw_changesets_countries tables from a changeset file </p>

</div>
</div>
<a id="a8048675cb3b9451a7b9b187a570cbd46"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8048675cb3b9451a7b9b187a570cbd46">&#9670;&nbsp;</a></span>threadStatistics()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void threads::threadStatistics </td>
          <td>(</td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>database</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ptime &amp;&#160;</td>
          <td class="paramname"><em>timestamp</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>This updates the calculated fields in the raw_changesets table, based on the data in the OSM stats database. These should be calculated by the OsmChange thread, but as changesets and osmchange files are on different timestamps, this looks for anything that got missed. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
